# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Обзор проекта

Проект для ведения настольной ролевой игры **Warhammer Fantasy Roleplay 4e (WFRP 4e)**. Содержит материалы для Мастера игры: правила, персонажей игроков, историю сессий и промты для ИИ-мастера.

## Архитектура

### Основные компоненты

1. **Правила и референсы**
   - `rules/` - директория с правилами, разбитыми по главам:
     - `WFRPG4E.ru.FULL.md` - полный файл правил (36360 строк)
     - `01_введение.md` - введение, основы НРИ
     - `02_персонаж.md` - создание персонажа
     - `03_классы_и_карьеры.md` - все классы и карьеры
     - `04_навыки_и_таланты.md` - список навыков и талантов
     - `05_правила.md` - механики игры
     - `06_между_приключениями.md` - занятия между приключениями
     - `07_религия_и_вера.md` - боги, церкви, чудеса
     - `08_магия.md` - школы магии и заклинания
     - `09_ведущий.md` - советы ведущему
     - `10_славный_рейкланд.md` - описание региона
     - `11_руководство_покупателя.md` - оружие, снаряжение, товары
     - `12_бестиарий.md` - монстры и существа
     - `README.md` - навигация по главам
   - `Ширма.txt` - быстрые таблицы сложности, модификаторы, справочные материалы
   - `game_master_prompt.md` - основной промт для ИИ-мастера с детальными инструкциями по ведению игры
   - **Поиск в правилах**: **ВСЕГДА используй RAG-MCP-SERVER** для поиска по правилам игры - это обязательный инструмент для работы с правилами
   - **Правила использования RAG-MCP-SERVER**:
     ```
     server_id: "fa896bc7-d78d-41bb-b60c-75ecbf309e8e"
     tool: "search_relevant_code"
     parameters: {"file_filter":".md","limit":5,"query":"твой запрос"}
     ```
   - Примеры запросов:
     - "имущество за карьеру"
     - "начальное богатство персонажа"
     - "правила боя инициатива"

2. **Организация игровых кампаний** (`history/%game_name%/`)
   - **Структура**: Каждая игра хранится в отдельной директории
   - **При старте новой игры**: ВСЕГДА запрашивай название и создавай соответствующую директорию
   
3. **Персонажи игроков** (`history/%game_name%/characters/`)
   - `party_summary.md` - сводная таблица характеристик всей партии с балансировкой и тактиками
   - `character_*.md` - детальные профили персонажей (характеристики, навыки, таланты, снаряжение, предыстория)
   - Всегда читать перед началом действия персонажа

4. **История игры** (`history/%game_name%/*.md`)
   - Хронологические записи игровых сессий
   - Формат имен: `YYYY-MM-DD_HH-MM_description.md`
   - Содержат полные записи раундов и событий
   - Читать последние 2-3 файла для понимания контекста

4. **Сценарии**
   - `Рассказ. Властелины болота.docx.txt` - текущий сценарий приключения

5. **Утилиты** (Python)
   - `generate_character_cards.py` - генератор карточек персонажей в PDF
   - `pdf_to_md.py` - конвертер PDF в Markdown

### Текущее состояние игры

**Партия (4 персонажа):**
- Фелиран - Лесной эльф, Охотник (стрелок/разведчик)
- Курт Шталер - Человек, Шарлатан (социальные навыки/обман)
- Дитрих Руссель - Человек, Огненный маг (боевая магия)
- Торгрим Железнобород - Дварф, Воин (танк)

**Последняя сессия:** Битва на барже "Удача Мананна" против Властелинов болота - партия выжила, но понесла тяжелые ранения.

## Команды для работы

### Генерация карточек персонажей

```bash
python3 generate_character_cards.py
```

Создает `wfrp_character_cards.pdf` с карточками всех персонажей.

**Зависимости:**
- `reportlab` - генерация PDF
- `PyMuPDF` (fitz) - работа с PDF

### Конвертация PDF в Markdown

```bash
python3 pdf_to_md.py <input.pdf> <output.md>
```

Конвертирует PDF файл в Markdown для удобного чтения.

### Работа с виртуальным окружением

```bash
# Активация (если используется)
source venv/bin/activate

# Установка зависимостей (если нужно)
pip install reportlab PyMuPDF
```

## Workflow ведения игры

### Перед действием персонажа:

1. Проверить актуальный файл персонажа в `history/%game_name%/characters/`
2. Убедиться, что навык/оружие/предмет есть у персонажа
3. Проверить текущее состояние (HP, условия, сломанное снаряжение)

### При создании новых персонажей:

**КРИТИЧЕСКИ ВАЖНО: Проверка снаряжения и богатства**

1. **Снаряжение** должно соответствовать правилам:
   - **Имущество за класс**: персонаж получает базовые предметы (кинжал, кошель, одежда и т.д.)
   - **Имущество за карьеру**: персонаж получает **ВСЕ предметы, перечисленные в строчке "Имущество" первой ступени его карьеры**
   - Перечень имущества - это необходимый минимум для представителя карьеры

2. **Богатство** рассчитывается по статусу (стр. 2720-2754):
   - Медное сословие: **2d10 медных пенни × уровень**
   - Серебряное сословие: **1d10 серебряных шиллингов × уровень**
   - Золотое сословие: **1 золотая крона × уровень**

3. **Примеры**:
   - Бронза 3 = 6d10 мп (~33 мп среднее, макс. 60 мп)
   - Серебро 1 = 1d10 сш (~5.5 сш среднее, макс. 10 сш)
   - Золото 2 = 2 зк

**НЕ допускай завышенных сумм денег у начинающих персонажей!**

### После раунда/сессии:

Сохранить историю в `history/%game_name%/`:
```bash
# Формат файла
history/%game_name%/2026-01-19_21-30_round_description.md
```

### При неясностях с правилами:

1. Проверить `Ширма.txt` для быстрых справок
2. **ВСЕГДА используй RAG-MCP-SERVER** для поиска по правилам игры в `rules/` - это основной инструмент для быстрого и точного поиска
3. При необходимости читать конкретные главы из `rules/01_введение.md` до `rules/12_бестиарий.md`
4. Использовать `game_master_prompt.md` для понимания стиля ведения

### Утилиты для работы с правилами:

```bash
# Разделение полного файла правил на главы
# (уже выполнено, но можно перезапустить при необходимости)
python3 split_rules.py
```

**Описание**: Скрипт `split_rules.py` разбивает большой файл `WFRPG4E.ru.FULL.md` на 12 отдельных глав для удобства навигации и поиска. Все файлы сохраняются в директории `rules/` с автоматическим созданием `README.md` для навигации.

## Критически важные правила ведения

### Проверки характеристик
- НЕ требовать проверку на каждое действие
- Проверки только для значимых и рискованных действий
- Примерная частота: каждое 3-5 действие
- **Кубики бросают игроки** - мастер только говорит что бросать

### Баланс боёв
- **НЕ БОЛЕЕ 3 противников на одного игрока**
- Уровень сложности не выше среднего (исключение: финальные боссы)
- Всегда предоставлять альтернативы прямому бою

### Темп игры
- НЕ форсировать события
- Давать время на ролевую игру и социальные сцены
- Чередовать боевые, социальные и исследовательские сцены
- Спрашивать игроков что они хотят делать

### Мрачный реализм (18+)
- Детальные описания окружения (запахи, звуки, текстуры)
- Жестокость и насилие описывать реалистично
- Грубая речь допустима для атмосферы
- **Но:** логи в коде всегда на английском языке

### Учёт всех NPC
- Если NPC появился в сцене, он не исчезает
- Дружественные NPC должны быть активны
- Учитывать всех участников сцены при описании

## Важные моменты при разработке

### Комментарии в коде
Все комментарии в коде пишутся на русском языке (кроме логов).

### Конфиденциальность
- Никогда не читать и не сканировать `.env` файлы
- Не индексировать файлы с токенами и секретами

### Структура данных персонажей
При работе с характеристиками персонажей учитывать полную структуру:
- Основные: WS, BS, S, T, I, Ag, Dex, Int, WP, Fel
- Вторичные: HP, Судьба, Удача, Несгибаемость, Решимость, Движение
- Навыки с модификаторами
- Таланты (дают бонусы в определенных ситуациях)
- Снаряжение (оружие с характеристиками, броня по зонам)
- Качества персонажа (плюсы/минусы, влияющие на игру)

### Формат сохранения истории
```markdown
# Раунд N / Описание события

[Дата и время]

## Контекст
[Что происходило до этого]

## Действия
[Подробное описание действий персонажей и NPC]

## Проверки
[Описание бросков, сложности, результатов]

## Результат
[Итоги раунда, изменения состояния]
```

## Системные файлы

- `CLAUDE.md` - аналогичный файл для Claude AI (содержит дублирующую информацию)
- `venv/` - виртуальное окружение Python (не трогать)
- `.git/` - система контроля версий
- `.idea/` - настройки PyCharm IDE

## Справочные материалы

Все материалы на русском языке, кроме:
- Логов в коде (английский)
- Технической документации в комментариях (русский)
- Названий файлов и переменных (английский/латиница)
