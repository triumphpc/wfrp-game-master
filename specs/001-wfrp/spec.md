# Feature Specification: WFRP Game Master Bot

**Feature Branch**: `001-wfrp`
**Created**: 2025-02-15
**Status**: Draft
**Input**: User description: "написать бот для ведения игры WFRP, который будет агентом ведения игры и GM, взаимодействовать с моделями LLM через провайдеров и вести игру"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Telegram Bot Integration (Priority: P1)

Пользователи группы @WHFR4 должны иметь возможность взаимодействовать с ботом Telegram для проведения игровых сессий WFRP 4e.

**Почему этот приоритет**: Основной канал взаимодействия с игроками — Telegram, без интеграции функционал ведения игры недоступен. Это фундаментальная треба для всей системы.

**Независимая проверка**: Может быть полностью протестировано через проверку регистрации бота, обработки команд и ответов в группе, без необходимости запуска LLM интеграции.

**Сценарии приятия**:

1. **Given** Бот добавлен в группу @WHFR4, **When** Пользователь отправляет команду в чат, **Then** Бот отвечает на команду
2. **Given** Бот работает в фоновом режиме, **When** Игрок пишет сообщение, **Then** Бот интерактивно проверяет наличие вводных данных каждую секунду
3. **Given** Бот настроен с провайдером LLM, **When** Получено сообщение от игрока, **Then** Бот формирует запрос к LLM с контекстом и отправляет ответ игрокам
4. **Given** Сессия игры активна, **When** Игрок выполняет действие, **Then** Бот обновляет карточку персонажа согласно правилам
5. **Given** Логируется событие сессии, **When** Событие завершено, **Then** Бот сохраняет запись в файл истории кампании

---

### User Story 2 - LLM Provider Integration (Priority: P1)

Бот должен интегрироваться с провайдерами LLM для получения ответов от Мастера игры (GM) согласно промтам.

**Почему этот приоритет**: Интеграция с LLM — это "мозг" бота, без неё невозможна никакая функциональность ведения игры. Критическая зависимость от первого юзер-стори.

**Независимая проверка**: Может быть протестировано через вызовы тестового провайдера и проверку корректности формирования запросов и обработки ответов.

**Сценарии приятия**:

1. **Given** Бот настроен с провайдером (z.ai, open.ai, minimax и др.), **When** Отправлен запрос к API, **Then** Получен корректный ответ в формате JSON/текст
2. **Given** Контекст игры содержит карточки персонажей, **When** Бот формирует запрос к LLM, **Then** Контекст корректно включён в промт
3. **Given** Провайдер возвращает ошибку/тайм-аут, **When** Бот получает ответ, **Then** Бот корректно обрабатывает ошибку и сообщает игрокам
4. **Given** Используется несколько провайдеров одновременно, **When** Бот выбирает провайдер, **Then** Запрос отправляется на выбранный провайдер
5. **Given** Провайдер поддерживает стриминг ответов, **When** LLM генерирует длинное описание, **Then** Бот интерактивно отправляет частями в Telegram

---

### User Story 3 - Configuration Management (Priority: P2)

Администратор должен иметь возможность настраивать бота (выбор провайдера, токен, идентификатор группы) без перекомпиляции.

**Почему этот приоритет**: Важно для удобства эксплуатации, но может быть временно решено через конфигурационные файлы. Не блокирует MVP.

**Независимая проверка**: Может быть протестировано через изменение настроек и проверку их применения без перезапуска бота.

**Сценарии приятия**:

1. **Given** Конфигурационный файл существует, **When** Администратор изменяет провайдер, **Then** Бот перезагружает конфигурацию и использует новый провайдер
2. **Given** Добавлен новый токен, **When** Бот перезагружается, **Then** Новый токен используется для API вызовов
3. **Given** Указан идентификатор группы, **When** Бот запускается, **Then** Бот подключается к указанной группе
4. **Given** Провайдер настроен с кастомными параметрами, **When** Бот делает запрос, **Then** Параметры корректно применяются

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА поддерживать интеграцию с Telegram Bot API
- **FR-002**: Система ДОЛЖНА поддерживать несколько провайдеров LLM (z.ai, open.ai, minimax)
- **FR-003**: Бот ДОЛЖЕН каждую секунду проверять наличие вводных данных в группе
- **FR-004**: Система ДОЛЖНА формировать запросы к LLM с промтами из `.claude/agents/gm.md`
- **FR-005**: Бот ДОЛЖЕН обновлять карточки персонажей после каждого действия
- **FR-006**: Система ДОЛЖНА сохранять логи сессий в файлы `history/[campaign]/`
- **FR-007**: Бот ДОЛЖЕН поддерживать переключение провайдеров без перекомпиляции
- **FR-008**: Бот ДОЛЖЕН корректно обрабатывать ошибки API провайдеров
- **FR-009**: Система ДОЛЖНА поддерживать интерактивную отправку длинных сообщений (streaming)
- **FR-010**: Бот ДОЛЖЕН проверять правила через RAG-MCP-Server при необходимости
- **FR-011**: Конфигурация ДОЛЖНА храниться отдельно от кода (env файл или конфиг)
- **FR-012**: Бот ДОЛЖЕН поддерживать несколько кампаний одновременно
- **FR-013**: Система ДОЛЖНА поддерживать форматирование карточек персонажей по шаблону
- **FR-014**: Бот ДОЛЖЕН обеспечивать изоляцию между разными кампаниями в одной группе

### Key Entities

- **Bot Instance**: Экземпляр бота, подключённый к группе Telegram с текущим состоянием
- **LLM Provider**: Конфигурация провайдера (URL, API ключ, модель, параметры)
- **Game Session**: Активная игровая сессия с контекстом (персонажи, NPC, сценарии)
- **Character Card**: Карточка персонажа с текущим состоянием (HP, опыт, снаряжение)
- **Player Message**: Входящее сообщение от игрока с текстом и метаданными
- **LLM Response**: Ответ от LLM с текстом GM и действиями по обновлению состояния
- **Campaign History**: Файловая система для хранения логов сессий с правильным форматированием

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователи могут взаимодействовать с ботом в Telegram в течение 3 секунд после отправки сообщения
- **SC-002**: Бот корректно интегрируется минимум с двумя провайдерами LLM
- **SC-003**: Карточки персонажей обновляются в течение 30 секунд после действия в игре
- **SC-004**: Смена провайдера LLM происходит без перезапуска бота (hot-reload)
- **SC-005**: Логи сессий сохраняются в файловой системе с правильным форматированием
- **SC-006**: Бот обрабатывает ошибки провайдеров с информированием администратора
- **SC-007**: При одновременной работе 10 игроков в одной группе задержка ответа не превышает 10 секунд
- **SC-008**: Длинные сообщения от LLM (более 4096 символов) отправляются частями без потери данных
- **SC-009**: Бот проверяет правила через RAG-MCP-Server при необходимости
